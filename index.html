<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Shop Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ['Inter', 'sans-serif'],
            }
          }
        }
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    </head>
<body class="bg-gray-100 font-inter">

<div id="root" class="bg-gray-100 flex flex-col items-center justify-start min-h-screen p-4">
    <div id="game-container" class="bg-white rounded-2xl shadow-2xl p-6 md:p-10 max-w-5xl w-full flex flex-col gap-8">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Coffee Shop Simulator</h1>
        <div id="game-content"></div>
    </div>
    <div id="message-box" class="fixed inset-0 bg-gray-500/50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white border border-gray-300 rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
            <h3 id="message-title" class="text-2xl font-bold text-gray-900 mb-4"></h3>
            <p id="message-text" class="text-gray-700 mb-6"></p>
            <div id="high-score-list" class="my-4 text-left"></div>
            <div class="flex justify-center">
                <button id="message-close-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl transition duration-300">OK</button>
            </div>
        </div>
    </div>
    <div id="price-modal" class="fixed inset-0 bg-gray-500/50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white border border-gray-300 rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
            <div class="space-y-2">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">Adjust Menu Prices</h3>
                <p class="text-gray-700 mb-6">Set the price for your coffee.</p>
            </div>
            <div class="grid gap-4 py-4">
                <div class="grid grid-cols-4 items-center gap-4">
                    <label for="price-input" class="col-span-2 text-right block text-lg font-medium text-gray-700">Coffee</label>
                    <input id="price-input" type="number" class="col-span-2 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                </div>
            </div>
            <div class="flex justify-center">
                <button id="price-close-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl transition duration-300">Close</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
"use strict";

// --- Firebase SDK Imports (UPDATED to v12.0.0) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

// --- Your web app's Firebase configuration (PASTED FROM YOUR PROVIDED SCRIPT INFO) ---
const firebaseConfig = {
    apiKey: "AIzaSyDo1GxUHgC0ws5__fcykyXOIx99QleK6PE",
    authDomain: "build-a-coffee-shop.firebaseapp.com",
    projectId: "build-a-coffee-shop",
    storageBucket: "build-a-coffee-shop.firebasestorage.app",
    messagingSenderId: "914283592902",
    appId: "1:914283592902:web:c29e2f4ea4ec692d81abc7",
    measurementId: "G-KHV9W49XN5"
};

const appId = firebaseConfig.appId; // Use the appId from your firebaseConfig
const initialAuthToken = null; // Keep this null unless you have a specific custom auth token

// --- Global state and configurations ---
let gameState = {};
window.planningState = {}; // Still making this global for easy access in render functions
let gameInterval = null;
let highScores = [];
let db = null;
let auth = null;
let analytics = null; // Declare analytics variable
let userId = null;

// Data configurations, simplified to one menu item
const configs = {
    locations: {
        downtown: { name: 'Downtown', rent: 15000, customerTraffic: 1.5, competition: 1.2 },
        suburbs: { name: 'Suburbs', rent: 5000, customerTraffic: 0.8, competition: 0.5 },
        college: { name: 'College Campus', rent: 10000, customerTraffic: 1.2, competition: 1.0 },
    },
    equipment: {
        basic: { name: 'Basic', cost: 10000, quality: 0.5 },
        standard: { name: 'Standard', cost: 25000, quality: 0.8 },
        pro: { name: 'Pro', cost: 40000, quality: 1.2 },
    },
    suppliers: {
        budget: { name: 'Budget Beans', costPerCup: 1.0, qualityFactor: 0.5 },
        premium: { name: 'Premium Blend', costPerCup: 2.0, qualityFactor: 1.0 },
        gourmet: { name: 'Gourmet Reserve', costPerCup: 3.0, qualityFactor: 1.5 },
    },
    menuItems: [
        { id: 'coffee', name: 'Coffee', baseCost: 1.5, basePrice: 3, qualityFactor: 1.0 },
    ],
    baristaSkills: ['Speed', 'Quality', 'Charm'],
    supplyCosts: { coffeeCup: 1.0 }, // Combined cost for beans, milk, and cup
    supplyOrderSize: 10000, // Fixed amount to order
};

const weatherConditions = ['Sunny', 'Rainy', 'Cloudy'];

// --- High Score Functions using Firestore ---
const setupFirestore = async () => {
    try {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        analytics = getAnalytics(app); // Initialize analytics here

        // Sign in the user
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

        // Listen for auth state changes and set the user ID
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                console.log("Authenticated with user ID:", userId);
                // Start listening for high scores once authenticated
                listenForHighScores();
            } else {
                console.log("No user is signed in.");
                userId = crypto.randomUUID(); // Use a random UUID if not authenticated
                listenForHighScores();
            }
            render(); // Call render after auth state is known
        });

    } catch (e) {
        console.error("Error setting up Firebase:", e);
    }
};

const listenForHighScores = () => {
    if (!db) {
        console.error("Firestore is not initialized.");
        return;
    }
    const highScoresRef = collection(db, `/artifacts/${appId}/public/data/highScores`);
    const q = query(highScoresRef, orderBy('days'), orderBy('playerName'));

    onSnapshot(q, (snapshot) => {
        const scores = [];
        snapshot.forEach((doc) => {
            scores.push({ ...doc.data(), id: doc.id });
        });
        highScores = scores.slice(0, 5); // Keep top 5 scores
        console.log("High scores updated:", highScores);
        render(); // Re-render the UI to show the updated scores
    }, (error) => {
        console.error("Error fetching high scores:", error);
    });
};

const saveHighScoreToFirestore = async (playerName, days) => {
    if (!db) {
        console.error("Firestore is not initialized.");
        return;
    }
    const highScoresRef = collection(db, `/artifacts/${appId}/public/data/highScores`);
    try {
        await addDoc(highScoresRef, {
            playerName,
            days,
            timestamp: new Date()
        });
        console.log("High score saved successfully!");
    } catch (e) {
        console.error("Error saving high score:", e);
    }
};

// --- Helper Functions for UI ---
const showMessage = (title, message, onClose = () => {}) => {
    document.getElementById('message-title').innerText = title;
    document.getElementById('message-text').innerText = message;
    
    const highScoreListDiv = document.getElementById('high-score-list');
    highScoreListDiv.innerHTML = ''; // Clear previous scores
    
    if (highScores && highScores.length > 0) {
        let scoresHTML = '<h4 class="text-xl font-bold mb-2">High Scores</h4><ol class="list-decimal list-inside space-y-1">';
        highScores.forEach((score, index) => {
            scoresHTML += `<li class="flex justify-between items-center bg-gray-100 p-2 rounded-md"><span class="font-medium">${score.playerName}</span><span class="text-sm text-gray-600">${score.days} days</span></li>`;
        });
        scoresHTML += '</ol>';
        highScoreListDiv.innerHTML = scoresHTML;
    } else {
        highScoreListDiv.innerHTML = '<p class="text-gray-500">No high scores yet. Be the first!</p>';
    }

    document.getElementById('message-box').classList.remove('hidden');
    const closeBtn = document.getElementById('message-close-btn');
    if (closeBtn._eventListenerAdded) {
        closeBtn.removeEventListener('click', closeBtn._eventListenerAdded);
    }
    const closeMessageListener = () => {
        document.getElementById('message-box').classList.add('hidden');
        onClose();
    };
    closeBtn.addEventListener('click', closeMessageListener);
    closeBtn._eventListenerAdded = closeMessageListener;
};

const showPriceModal = () => {
    const priceModal = document.getElementById('price-modal');
    priceModal.classList.remove('hidden');
    const priceInput = document.getElementById('price-input');
    priceInput.value = gameState.menuPrices.coffee;

    // Remove previous event listener before adding a new one to prevent duplicates
    if (priceInput._eventListenerAdded) {
        priceInput.removeEventListener('change', priceInput._eventListenerAdded);
    }
    const priceChangeListener = (e) => {
        const newPrice = parseInt(e.target.value) || 0;
        if (newPrice > 0) {
              gameState.menuPrices.coffee = newPrice;
              addLog(`You adjusted the price of coffee to $${newPrice}.`, 'daily', 'text-teal-600');
        }
    };
    priceInput.addEventListener('change', priceChangeListener);
    priceInput._eventListenerAdded = priceChangeListener; // Store reference to remove later
    
    const closeBtn = document.getElementById('price-close-btn');
    if (closeBtn._eventListenerAdded) {
        closeBtn.removeEventListener('click', closeBtn._eventListenerAdded);
    }
    const closePriceModalListener = () => {
        priceModal.classList.add('hidden');
        render();
    };
    closeBtn.addEventListener('click', closePriceModalListener);
    closeBtn._eventListenerAdded = closePriceModalListener;
};

// --- Game Logic Functions ---
const addLog = (message, type = 'daily', color = 'text-gray-600') => {
    const newLogEntry = { message, color, day: gameState.day };
    if (type === 'event') {
        gameState.eventLog.unshift(newLogEntry);
        gameState.eventLog = gameState.eventLog.slice(0, 10);
    } else {
        gameState.dailyLog.unshift(newLogEntry);
        gameState.dailyLog = gameState.dailyLog.slice(0, 20);
    }
};

const endGame = (message) => {
    clearInterval(gameInterval);
    gameState.isGameOver = true;
    gameState.phase = 'gameover';
    
    // Check if the player won to save the score
    if (gameState.customers >= 100000) {
        saveHighScoreToFirestore(gameState.playerName, gameState.day);
    }

    showMessage("Game Over", message, () => window.location.reload());
};

const handleRandomEvent = () => {
  const eventChance = Math.random();
  if (eventChance < 0.1) { // 10% chance per day
    const events = [
      { type: 'positive', message: 'A local food blogger gave you a great review! Reputation boosted!', action: () => {
        gameState.reputation = Math.min(1.0, gameState.reputation + 0.05);
        addLog("A popular food blogger posted a rave review of your shop! Reputation boosted!", 'event', 'text-green-600 font-bold');
      }},
      { type: 'negative', message: 'Oh no! Your espresso machine broke down. Repairs will cost $5,000.', action: () => {
        gameState.money -= 5000;
        gameState.equipmentHealth = 0.5;
        addLog("Equipment breakdown! Repairs cost $5,000. Your equipment health is now 50%.", 'event', 'text-red-600 font-bold');
      }},
      { type: 'neutral', message: 'A local competitor is offering a new deal. You chose to ignore it, but your reputation took a small hit.', action: () => {
        gameState.reputation = Math.max(0.1, gameState.reputation - 0.03);
        addLog("You noticed a competitor's new deal. You chose to ignore it, which slightly impacted your reputation.", 'event', 'text-yellow-600 font-bold');
      }},
    ];

    const event = events[Math.floor(Math.random() * events.length)];
    event.action();
  }
};

const gameLoop = () => {
    if (gameState.isGameOver) return;
    
    gameState.day++;
    const newMonth = Math.floor(gameState.day / 30);
    const isMonthEnd = gameState.day % 30 === 0;

    // Monthly expenses
    if (isMonthEnd) {
        const totalMonthlyExpenses = gameState.rent + (gameState.loan ? gameState.loan.payment : 0);
        gameState.money -= totalMonthlyExpenses;
        addLog(`End of Month ${newMonth}: Paid rent ($${gameState.rent}) and loan payments ($${gameState.loan ? gameState.loan.payment : 0}). Total: $${totalMonthlyExpenses}.`, 'daily', 'text-red-600');
        if (gameState.money <= 0) {
            endGame(`You ran out of money at the end of the month! Your shop has closed.`);
            return;
        }
    }

    // Natural decay
    gameState.baristas.forEach(b => b.morale = Math.max(0, b.morale - 0.005));
    gameState.equipmentHealth = Math.max(0, gameState.equipmentHealth - 0.005);
    
    // Random events
    handleRandomEvent();
    
    // Generate weather and day of the week
    gameState.weather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
    const isWeekend = (gameState.day % 7 === 6 || gameState.day % 7 === 0);

    // Calculate daily income
    const { locationConfig, supplierConfig, equipmentConfig } = gameState.businessPlan;
    let dailyTraffic = (gameState.customers === 0 ? gameState.businessPlan.marketingBudget / 50 : gameState.customers) * locationConfig.customerTraffic;
    
    if (isWeekend) dailyTraffic *= 1.5;
    if (gameState.weather === 'Rainy') dailyTraffic *= 1.2;
    
    let customersToday = Math.floor(dailyTraffic * gameState.reputation * (1 - locationConfig.competition/10));
    
    // Inventory & sales logic, simplified to one item
    let revenue = 0;
    let totalIngredientCosts = 0;
    let servedCustomers = 0;

    // The cost of supplies now includes the supplier cost
    const costPerCup = supplierConfig.costPerCup + configs.supplyCosts.coffeeCup;

    const cupsToSell = Math.min(customersToday, gameState.inventory.coffeeCups);
    
    if (cupsToSell > 0) {
        servedCustomers = cupsToSell;
        revenue = (servedCustomers * gameState.menuPrices.coffee);
        totalIngredientCosts = (servedCustomers * costPerCup); 
    }

    const dailyProfit = revenue - totalIngredientCosts;
    gameState.money += dailyProfit;

    // Update reputation
    const qualityFactor = (equipmentConfig.quality + supplierConfig.qualityFactor) / 2;
    const moraleFactor = gameState.baristas.reduce((sum, b) => sum + b.morale, 0) / (gameState.baristas.length || 1);
    gameState.reputation = Math.max(0.1, Math.min(1.0, gameState.reputation + ((qualityFactor * moraleFactor) - gameState.reputation) * 0.01));
    
    // Log daily summary
    addLog(`Served ${servedCustomers} customers. Daily revenue: $${revenue.toFixed(2)}. Profit: $${dailyProfit.toFixed(2)}.`, 'daily', dailyProfit > 0 ? 'text-green-600' : 'text-red-600');

    // Update inventory
    gameState.inventory.coffeeCups -= servedCustomers;

    // Update customers
    gameState.customers += Math.floor(servedCustomers * 0.1);

    // Check for game over
    if (gameState.money <= 0) {
        endGame(`You ran out of money on day ${gameState.day}! Your coffee shop has closed.`);
        return;
    } else if (gameState.customers >= 100000) {
        endGame(`Congratulations, ${gameState.playerName}! You reached 100,000 customers in ${gameState.day} days and built a coffee empire! You win!`);
        return;
    }

    render(); // Call global render
};

const handleAction = (actionType) => {
    switch (actionType) {
        case 'market':
            if (gameState.money >= 1000) {
                gameState.money -= 1000;
                gameState.customers += Math.floor(Math.random() * 1000) + 200;
                addLog("You ran a marketing campaign and gained new customers!", 'daily', 'text-blue-600');
            } else { showMessage("Not Enough Money", "You don't have enough cash for a marketing campaign."); }
            break;
        case 'hire':
            if (gameState.money >= 2500) {
                gameState.money -= 2500;
                const newBarista = {
                    id: gameState.baristas.length,
                    morale: 1.0,
                    salary: 2500,
                    skills: { speed: Math.random() * 0.5 + 0.5, quality: Math.random() * 0.5 + 0.5 },
                };
                gameState.baristas.push(newBarista);
                addLog("You hired a new barista! Service speed should improve.", 'daily', 'text-indigo-600');
            } else { showMessage("Not Enough Money", "You don't have enough cash to hire a new barista."); }
            break;
        case 'upgrade':
            let upgradeCost;
            let newEquipment;
            if (gameState.equipment === 'basic') {
                newEquipment = 'standard';
                upgradeCost = configs.equipment.standard.cost - configs.equipment.basic.cost;
            } else if (gameState.equipment === 'standard') {
                newEquipment = 'pro';
                upgradeCost = configs.equipment.pro.cost - configs.equipment.standard.cost;
            } else {
                showMessage("Maxed out", "Your equipment is already at the highest level.");
                return;
            }

            if (gameState.money >= upgradeCost) {
                gameState.money -= upgradeCost;
                gameState.equipment = newEquipment;
                // NEW LOGIC: Restore equipment health to 100% after upgrade
                gameState.equipmentHealth = 1.0;
                addLog(`You upgraded your equipment to ${configs.equipment[newEquipment].name}! It's brand new and working perfectly.`, 'event', 'text-yellow-600');
            } else { showMessage("Not Enough Money", `You can't afford the ${configs.equipment[newEquipment].name} upgrade.`); }
            break;
        case 'take_loan':
            if (!gameState.loan) {
                gameState.loan = { amount: 10000, payment: 1000 };
                gameState.money += 10000;
                addLog('You took out a $10,000 loan with a $1,000 monthly payment.', 'event', 'text-green-600');
            } else { showMessage("Already have a loan", "You can only have one loan at a time."); }
            break;
        case 'order_supplies':
            const suppliesCost = configs.supplyOrderSize * configs.supplyCosts.coffeeCup;
            if (gameState.money >= suppliesCost) {
                gameState.money -= suppliesCost;
                gameState.inventory.coffeeCups += configs.supplyOrderSize;
                addLog(`Ordered ${configs.supplyOrderSize} coffee supplies for $${suppliesCost.toFixed(2)}.`, 'daily', 'text-green-600');
            } else { showMessage("Not Enough Money", "You don't have enough cash to order more coffee supplies."); }
            break;
        case 'show_prices':
            showPriceModal();
            break;
    }
    render(); // Call global render
};

const handlePlanFinalization = () => {
    if (!window.planningState.playerName) {
        showMessage("Enter a Name", "Please enter your name to start the game.");
        return;
    }
    const plan = window.planningState;
    const equipmentConfig = configs.equipment[plan.equipment];
    const upfrontCost = equipmentConfig.cost + plan.baristaCount * 2500 + plan.marketingBudget;

    if (50000 - upfrontCost < 0) {
        showMessage("Not Enough Capital", "Your upfront costs exceed your starting capital. Please adjust your business plan.");
        return;
    }

    const newBaristas = Array.from({ length: plan.baristaCount }, (_, i) => ({
        id: i, morale: 1.0, salary: 2500,
        skills: { speed: Math.random() * 0.5 + 0.5, quality: Math.random() * 0.5 + 0.5 },
    }));

    gameState = {
        phase: 'running',
        playerName: window.planningState.playerName,
        money: 50000 - upfrontCost,
        initialCapital: 50000,
        day: 0, month: 0, customers: 0, reputation: 0.5, baristas: newBaristas,
        equipment: plan.equipment, rent: configs.locations[plan.location].rent,
        menuPrices: { coffee: 3 }, dailyLog: [], eventLog: [], isGameOver: false,
        businessPlan: {
            ...plan, upfrontCost,
            locationConfig: configs.locations[plan.location],
            equipmentConfig: equipmentConfig,
            supplierConfig: configs.suppliers[plan.supplier],
        },
        inventory: { coffeeCups: 1000 },
        loan: null, weather: 'Sunny', equipmentHealth: 1.0,
    };

    gameInterval = setInterval(gameLoop, 1500); // Day = 1.5s
    render(); // Call global render
};

// --- Rendering functions ---
const renderPlanningPhase = () => {
    const plan = window.planningState;
    let content = '';

    // Helper to create input fields
    const createInputField = (id, type, value, placeholder) => `
        <input type="${type}" id="${id}" value="${value}"
               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2"
               placeholder="${placeholder}">
    `;

    // Helper to create select fields
    const createSelectField = (id, value, options) => `
        <select id="${id}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            ${options.map(opt => `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.text}</option>`).join('')}
        </select>
    `;

    // Helper to create buttons
    const createButton = (id, text, className = "") => `
        <button id="${id}" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl transition duration-300 ${className}">
            ${text}
        </button>
    `;

    if (plan.step === 0) {
        content = `
            <div class="space-y-6">
                <label class="block text-lg font-medium text-gray-700">Your Name</label>
                ${createInputField('playerNameInput', 'text', plan.playerName, 'e.g., Alex')}
                ${createButton('nextStep0Btn', 'Next', 'w-full')}
            </div>
        `;
    } else if (plan.step === 1) {
        content = `
            <div class="space-y-6">
                <label class="block text-lg font-medium text-gray-700">Shop Name</label>
                ${createInputField('shopNameInput', 'text', plan.shopName, 'e.g., The Daily Grind')}
                <label class="block text-lg font-medium text-gray-700">Location</label>
                ${createSelectField('locationSelect', plan.location, [
                    { value: 'downtown', text: '$15,000 Rent/Month (High Traffic)' },
                    { value: 'suburbs', text: '$5,000 Rent/Month (Moderate Traffic)' },
                    { value: 'college', text: '$10,000 Rent/Month (High Student Traffic)' }
                ])}
                <div class="flex gap-4">
                    ${createButton('prevStep1Btn', 'Previous', 'w-1/2')}
                    ${createButton('nextStep1Btn', 'Next', 'w-1/2')}
                </div>
            </div>
        `;
    } else if (plan.step === 2) {
        content = `
            <div class="space-y-6">
                <label class="block text-lg font-medium text-gray-700">Equipment</label>
                ${createSelectField('equipmentSelect', plan.equipment, [
                    { value: 'basic', text: '$10,000 (Slow, Low Quality)' },
                    { value: 'standard', text: '$25,000 (Average Speed, Good Quality)' },
                    { value: 'pro', text: '$40,000 (Fast, High Quality)' }
                ])}
                <label class="block text-lg font-medium text-gray-700">Coffee Bean Supplier</label>
                ${createSelectField('supplierSelect', plan.supplier, [
                    { value: 'budget', text: 'Budget Beans ($1.00 per cup, low quality)' },
                    { value: 'premium', text: 'Premium Beans ($2.00 per cup, good quality)' },
                    { value: 'gourmet', text: 'Gourmet Beans ($3.00 per cup, high quality)' }
                ])}
                <div class="flex gap-4">
                    ${createButton('prevStep2Btn', 'Previous', 'w-1/2')}
                    ${createButton('nextStep2Btn', 'Next', 'w-1/2')}
                </div>
            </div>
        `;
    } else if (plan.step === 3) {
        content = `
            <div class="space-y-6">
                <label class="block text-lg font-medium text-gray-700">Initial Baristas</label>
                ${createInputField('baristaCountInput', 'number', plan.baristaCount, '')}
                <p class="text-sm text-gray-500">Each costs $2,500 upfront and in monthly salary.</p>
                <label class="block text-lg font-medium text-gray-700">Initial Marketing Budget</label>
                ${createInputField('marketingBudgetInput', 'number', plan.marketingBudget, '')}
                <p class="text-sm text-gray-500">One-time spend to get the word out on opening day.</p>
                <div class="flex gap-4">
                    ${createButton('prevStep3Btn', 'Previous', 'w-1/2')}
                    ${createButton('nextStep3Btn', 'Next', 'w-1/2')}
                </div>
            </div>
        `;
    } else if (plan.step === 4) {
        const upfrontCost = configs.equipment[plan.equipment].cost + plan.baristaCount * 2500 + plan.marketingBudget;
        const startingCash = 50000 - upfrontCost;
        content = `
            <div class="space-y-6">
                <h3 class="text-xl font-bold text-gray-700 text-center">Finalize Your Plan</h3>
                <div class="bg-gray-50 rounded-xl p-6 shadow-inner space-y-3">
                    <p><span>Player Name:</span> ${plan.playerName}</p>
                    <p><span>Shop Name:</span> ${plan.shopName}</p>
                    <p><span>Location:</span> ${configs.locations[plan.location].name}</p>
                    <p><span>Equipment:</span> ${configs.equipment[plan.equipment].name}</p>
                    <p><span>Supplier:</span> ${configs.suppliers[plan.supplier].name}</p>
                    <p><span>Baristas:</span> ${plan.baristaCount}</p>
                    <p><span>Initial Marketing:</span> $${plan.marketingBudget.toLocaleString()}</p>
                    <p class="font-bold"><span>Upfront Cost:</span> $${upfrontCost.toLocaleString()}</p>
                    <p class="font-bold"><span>Starting Cash:</span> $${startingCash.toLocaleString()}</p>
                </div>
                <div class="flex gap-4">
                    ${createButton('prevStep4Btn', 'Previous', 'w-1/2')}
                    ${createButton('openBusinessBtn', 'Open for Business!', 'w-1/2')}
                </div>
            </div>
        `;
    }

    document.getElementById('game-content').innerHTML = `
        <div class="flex flex-col gap-6">
            <h2 class="text-2xl font-semibold text-gray-700 text-center mb-4">Phase 1: Build Your Business Plan</h2>
            <div class="flex justify-center items-center gap-2 mb-6">
                ${[0, 1, 2, 3, 4].map(step => `<div class="w-4 h-4 rounded-full step-indicator ${window.planningState.step === step ? 'bg-indigo-500' : window.planningState.step > step ? 'bg-green-500' : 'bg-gray-300'}"></div>`).join('')}
            </div>
            ${content}
        </div>
    `;

    // --- Attach Event Listeners AFTER HTML is in the DOM ---
    if (plan.step === 0) {
        document.getElementById('playerNameInput')?.addEventListener('input', (e) => {
            window.planningState.playerName = e.target.value;
            render();
        });
        document.getElementById('nextStep0Btn')?.addEventListener('click', () => {
            window.planningState.step = 1;
            render();
        });
    } else if (plan.step === 1) {
        document.getElementById('shopNameInput')?.addEventListener('input', (e) => {
            window.planningState.shopName = e.target.value;
            render();
        });
        document.getElementById('locationSelect')?.addEventListener('change', (e) => {
            window.planningState.location = e.target.value;
            render();
        });
        document.getElementById('prevStep1Btn')?.addEventListener('click', () => {
            window.planningState.step = 0;
            render();
        });
        document.getElementById('nextStep1Btn')?.addEventListener('click', () => {
            window.planningState.step = 2;
            render();
        });
    } else if (plan.step === 2) {
        document.getElementById('equipmentSelect')?.addEventListener('change', (e) => {
            window.planningState.equipment = e.target.value;
            render();
        });
        document.getElementById('supplierSelect')?.addEventListener('change', (e) => {
            window.planningState.supplier = e.target.value;
            render();
        });
        document.getElementById('prevStep2Btn')?.addEventListener('click', () => {
            window.planningState.step = 1;
            render();
        });
        document.getElementById('nextStep2Btn')?.addEventListener('click', () => {
            window.planningState.step = 3;
            render();
        });
    } else if (plan.step === 3) {
        document.getElementById('baristaCountInput')?.addEventListener('input', (e) => {
            window.planningState.baristaCount = parseInt(e.target.value) || 0;
            render();
        });
        document.getElementById('marketingBudgetInput')?.addEventListener('input', (e) => {
            window.planningState.marketingBudget = parseInt(e.target.value) || 0;
            render();
        });
        document.getElementById('prevStep3Btn')?.addEventListener('click', () => {
            window.planningState.step = 2;
            render();
        });
        document.getElementById('nextStep3Btn')?.addEventListener('click', () => {
            window.planningState.step = 4;
            render();
        });
    } else if (plan.step === 4) {
        document.getElementById('prevStep4Btn')?.addEventListener('click', () => {
            window.planningState.step = 3;
            render();
        });
        document.getElementById('openBusinessBtn')?.addEventListener('click', handlePlanFinalization);
    }
};

const renderRunningPhase = () => {
    let nextUpgradeText = '';
    let nextUpgradeCost = 0;
    let isUpgradeAvailable = false;
    
    if (gameState.equipment === 'basic') {
        nextUpgradeText = `Upgrade to Standard ($${(configs.equipment.standard.cost - configs.equipment.basic.cost).toLocaleString()})`;
        nextUpgradeCost = configs.equipment.standard.cost - configs.equipment.basic.cost;
        isUpgradeAvailable = true;
    } else if (gameState.equipment === 'standard') {
        nextUpgradeText = `Upgrade to Pro ($${(configs.equipment.pro.cost - configs.equipment.standard.cost).toLocaleString()})`;
        nextUpgradeCost = configs.equipment.pro.cost - configs.equipment.standard.cost;
        isUpgradeAvailable = true;
    } else {
        nextUpgradeText = 'Max Equipment Level Reached';
        isUpgradeAvailable = false;
    }

    const dailyLogHTML = gameState.dailyLog.map((entry, index) => `<div class="${entry.color}">${entry.message}</div>`).join('');
    const eventLogHTML = gameState.eventLog.length > 0 ? 
        gameState.eventLog.map((entry, index) => `<div class="${entry.color}">${entry.message}</div>`).join('') : 
        '<div>No special events yet.</div>';
    
    document.getElementById('game-content').innerHTML = `
        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-2/3 flex flex-col gap-4">
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="bg-green-100 text-green-800 p-4 rounded-xl shadow-md text-center"> 
                        <div class="font-bold text-lg">Cash</div> 
                        <div class="text-2xl font-semibold">$${gameState.money.toLocaleString()}</div>
                    </div>
                    <div class="bg-blue-100 text-blue-800 p-4 rounded-xl shadow-md text-center flex flex-col justify-between"> 
                        <div>
                            <div class="font-bold text-lg">Customers</div>
                            <div class="text-2xl font-semibold">${gameState.customers.toLocaleString()}</div>
                        </div>
                        <button id="marketBtn" class="mt-2 px-3 py-1 text-sm bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition duration-300 ${gameState.money < 1000 ? 'opacity-50 cursor-not-allowed' : ''}">
                            Marketing ($1,000)
                        </button>
                    </div>
                    <div class="bg-yellow-100 text-yellow-800 p-4 rounded-xl shadow-md text-center"> 
                        <div class="font-bold text-lg">Day</div> 
                        <div class="text-2xl font-semibold">${gameState.day}</div>
                    </div>
                    <div class="bg-purple-100 text-purple-800 p-4 rounded-xl shadow-md text-center"> 
                        <div class="font-bold text-lg">Reputation</div> 
                        <div class="text-2xl font-semibold">${(gameState.reputation * 100).toFixed(1)}%</div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md flex-grow">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">${gameState.businessPlan.shopName} Status</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                        <p><strong>Location:</strong> ${configs.locations[gameState.businessPlan.location].name}</p>
                        <p><strong>Equipment:</strong> ${configs.equipment[gameState.equipment].name} (${(gameState.equipmentHealth * 100).toFixed(0)}% Health)</p>
                        <p><strong>Baristas:</strong> ${gameState.baristas.length}</p>
                        <p><strong>Coffee Price:</strong> $${gameState.menuPrices.coffee.toFixed(2)}</p>
                        <p><strong>Inventory:</strong> ${gameState.inventory.coffeeCups} cups</p>
                        <p><strong>Weather:</strong> ${gameState.weather}</p>
                        <p><strong>Monthly Rent:</strong> $${gameState.rent.toLocaleString()}</p>
                        ${gameState.loan ? `<p><strong>Loan Payment:</strong> $${gameState.loan.payment.toLocaleString()} / month</p>` : ''}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Actions</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="hireBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-xl transition duration-300 ${gameState.money < 2500 ? 'opacity-50 cursor-not-allowed' : ''}">
                            Hire Barista ($2,500)
                        </button>
                        <button id="upgradeBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-xl transition duration-300 ${!isUpgradeAvailable || gameState.money < nextUpgradeCost ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${nextUpgradeText}
                        </button>
                        <button id="orderSuppliesBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-xl transition duration-300 ${gameState.money < (configs.supplyOrderSize * configs.supplyCosts.coffeeCup) ? 'opacity-50 cursor-not-allowed' : ''}">
                            Order Supplies ($${(configs.supplyOrderSize * configs.supplyCosts.coffeeCup).toFixed(2)})
                        </button>
                        <button id="takeLoanBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition duration-300 ${gameState.loan ? 'opacity-50 cursor-not-allowed' : ''}">
                            Take Loan ($10,000)
                        </button>
                        <button id="showPricesBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl transition duration-300">
                            Adjust Prices
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:w-1/3 flex flex-col gap-4">
                <div class="bg-white p-6 rounded-xl shadow-md flex-grow">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Daily Log</h3>
                    <div class="space-y-2 text-sm max-h-60 overflow-y-auto">
                        ${dailyLogHTML || '<div class="text-gray-500">No daily events yet.</div>'}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md flex-grow">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Special Events</h3>
                    <div class="space-y-2 text-sm max-h-60 overflow-y-auto">
                        ${eventLogHTML}
                    </div>
                </div>
            </div>
        </div>
    `;

    // Attach event listeners for game actions after content is rendered
    document.getElementById('marketBtn')?.addEventListener('click', () => handleAction('market'));
    document.getElementById('hireBtn')?.addEventListener('click', () => handleAction('hire'));
    document.getElementById('upgradeBtn')?.addEventListener('click', () => handleAction('upgrade'));
    document.getElementById('orderSuppliesBtn')?.addEventListener('click', () => handleAction('order_supplies'));
    document.getElementById('takeLoanBtn')?.addEventListener('click', () => handleAction('take_loan'));
    document.getElementById('showPricesBtn')?.addEventListener('click', () => handleAction('show_prices'));
};

const renderGameOverPhase = () => {
    document.getElementById('game-content').innerHTML = `
        <div class="text-center space-y-6">
            <h2 class="text-3xl font-bold text-gray-800">Game Over!</h2>
            <button id="playAgainBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl transition duration-300">Play Again</button>
        </div>
    `;
    document.getElementById('playAgainBtn')?.addEventListener('click', () => window.location.reload());
};

// The main render function (now truly global and responsible for controlling the UI flow)
window.render = () => {
    if (gameState.isGameOver) {
        renderGameOverPhase();
    } else if (gameState.phase === 'planning') {
        renderPlanningPhase();
    } else if (gameState.phase === 'running') {
        renderRunningPhase();
    } else {
        window.planningState = {
            step: 0,
            playerName: '',
            shopName: 'My Coffee Shop',
            location: 'suburbs',
            equipment: 'basic',
            supplier: 'budget',
            baristaCount: 1,
            marketingBudget: 0,
        };
        gameState.phase = 'planning';
        renderPlanningPhase();
    }
};

// --- Initialize the Game ---
document.addEventListener('DOMContentLoaded', () => {
    setupFirestore();
    render(); // Initial render
});
</script>
</body>
</html>
